name: Docker Build Check

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Free up disk space
      run: |
        docker system prune -af
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
        sudo apt-get clean
        
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Create test .env file
      run: |
        cat <<EOF > .env
        MYSQL_ROOT_PASSWORD=testroot
        MYSQL_DATABASE=testdb
        MYSQL_USER=testuser
        MYSQL_PASSWORD=testpass

        DB_HOST=localhost
        DB_PORT=3306
        DB_USER=testuser
        DB_PASSWORD=testpass
        DB_NAME=testdb
        EOF

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build with Docker Compose
      run: |
        docker compose -f docker-compose.yml build
